<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KAFVI Intelligence Hub - Release Master</title>
    <!-- 고성능 디자인 엔진: Tailwind CSS & Font Awesome -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@700&family=Noto+Sans+KR:wght@300;400;700&display=swap');
        
        body {
            background-color: #05070a;
            color: #e2e8f0;
            font-family: 'Noto Sans KR', sans-serif;
            margin: 0;
            overflow: hidden;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .cyber-header {
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(25px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 4px 30px rgba(0,0,0,0.5);
        }

        .series-sidebar {
            width: 380px;
            background: rgba(15, 23, 42, 0.4);
            border-right: 1px solid rgba(255, 255, 255, 0.05);
            overflow-y: auto;
            scrollbar-width: none;
        }
        .series-sidebar::-webkit-scrollbar { display: none; }

        .report-card {
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            cursor: pointer;
            opacity: 0.6;
            transform: scale(0.96);
        }
        .report-card.active {
            opacity: 1;
            transform: scale(1.02);
            background: linear-gradient(90deg, rgba(0, 122, 255, 0.15) 0%, transparent 100%);
            border-left: 5px solid #007aff;
            box-shadow: 0 10px 40px rgba(0, 122, 255, 0.15);
        }

        .number-tag {
            font-family: 'Orbitron', sans-serif;
            background: #1e293b;
            @apply w-12 h-12 flex items-center justify-center rounded-xl text-lg font-bold;
        }
        .active .number-tag { 
            background: #007aff; color: white; box-shadow: 0 0 20px rgba(0, 122, 255, 0.5); 
        }

        .viewer-stage { flex: 1; background: #000; position: relative; }
        iframe { 
            width: 100%; height: 100%; border: none; background: white; 
            transition: transform 0.2s ease-out; transform-origin: top center;
        }

        .chat-panel {
            width: 420px;
            background: #0f172a;
            border-left: 1px solid rgba(255, 255, 255, 0.08);
            display: flex;
            flex-direction: column;
            box-shadow: -10px 0 50px rgba(0,0,0,0.5);
        }

        .chat-messages { flex: 1; overflow-y: auto; padding: 1.5rem; scrollbar-width: thin; scrollbar-color: #30363d transparent; }
        .chat-input-area { padding: 1.5rem; background: rgba(15, 23, 42, 0.9); border-top: 1px solid rgba(255, 255, 255, 0.1); }
        
        .loader { position: absolute; inset: 0; background: #05070a; z-index: 50; display: flex; align-items: center; justify-content: center; }
        .control-btn { @apply p-4 rounded-[1.2rem] bg-gray-900/90 border border-white/10 text-gray-400 hover:text-white hover:bg-blue-600 transition-all shadow-2xl active:scale-90; }
        .badge-v { @apply text-[9px] px-2 py-0.5 rounded-full bg-blue-600/20 text-blue-400 font-bold ml-2; }
    </style>
</head>
<body class="flex flex-col">

    <!-- CI Header -->
    <header class="cyber-header px-10 py-5 flex justify-between items-center z-50">
        <div class="flex items-center gap-6">
            <div class="p-4 bg-blue-600 rounded-[1.3rem] shadow-xl border border-blue-400/20 text-white">
                <i class="fa-solid fa-anchor text-2xl"></i>
            </div>
            <div>
                <h1 class="text-2xl font-black italic tracking-tighter uppercase text-white">KAFVI INTELLIGENCE HUB</h1>
                <p class="text-[11px] text-blue-500 font-bold uppercase tracking-[0.4em] mt-1 flex items-center gap-2">
                    <span class="w-2 h-2 rounded-full bg-blue-500 animate-pulse"></span>
                    Zero-Touch Release Sync Engine
                </p>
            </div>
        </div>
        <div class="flex items-center gap-10">
            <div class="text-right border-r border-gray-800 pr-8">
                <p class="text-[11px] text-gray-500 font-mono tracking-widest uppercase mb-1 italic text-right">Authorized Authority</p>
                <p class="text-lg font-black text-gray-200 text-right text-white">소장 김종천</p>
            </div>
            <button onclick="toggleChat()" class="text-blue-500 hover:text-blue-400 transition-all">
                <i class="fa-solid fa-robot text-3xl"></i>
            </button>
        </div>
    </header>

    <div class="flex flex-1 overflow-hidden">
        
        <!-- Sidebar: Automatic Asset Synchronizer -->
        <aside class="series-sidebar flex flex-col p-8 gap-5" id="sidebar">
            <div class="mb-6 px-2 border-b border-gray-800 pb-4 flex justify-between items-end">
                <div>
                    <h2 class="text-[12px] font-black text-gray-500 uppercase tracking-[0.5em] mb-2 text-gray-500 font-bold">Series Library</h2>
                    <p class="text-[10px] text-gray-600 italic font-medium">Automatic Release Sync</p>
                </div>
                <button onclick="fetchGitHubAssets()" class="text-blue-500 hover:rotate-180 transition-all duration-700 mb-1" title="강제 동기화">
                    <i class="fa-solid fa-arrows-rotate text-lg"></i>
                </button>
            </div>
            <div id="series-container" class="space-y-4">
                <!-- 리스트 자동 생성 -->
            </div>
        </aside>

        <!-- Main Stage -->
        <main class="viewer-stage" id="main-stage">
            <div id="loader" class="loader hidden">
                <div class="text-center">
                    <i class="fa-solid fa-compass fa-spin text-5xl text-blue-600 mb-6"></i>
                    <p id="loader-text" class="text-[11px] font-mono tracking-widest text-gray-500 uppercase animate-pulse italic text-white">Scanning Cloud...</p>
                </div>
            </div>

            <div id="welcome" class="absolute inset-0 flex flex-col items-center justify-center text-center p-16">
                <i class="fa-solid fa-cloud-arrow-down text-[120px] text-gray-900 mb-10 opacity-20 text-gray-900"></i>
                <h3 class="text-2xl font-black text-gray-600 italic tracking-tight uppercase">Intelligence Standby</h3>
                <p class="text-gray-700 text-sm mt-5 tracking-widest leading-relaxed max-w-md text-white">
                    릴리즈에 올라온 리포트를 자동으로 감지했습니다.<br>
                    리포트 클릭 시 다운로드 없이 즉시 화면에 플레이됩니다.
                </p>
            </div>

            <iframe id="viewer-frame" class="hidden"></iframe>

            <!-- Floating Toolset -->
            <div class="absolute bottom-10 right-10 flex gap-4 z-[60]">
                <button onclick="zoomViewer(1.1)" class="control-btn" title="확대"><i class="fa-solid fa-magnifying-glass-plus"></i></button>
                <button onclick="resetZoom()" class="control-btn"><span class="text-[11px] font-black w-12 text-gray-400" id="zoom-text">100%</span></button>
                <button onclick="zoomViewer(0.9)" class="control-btn" title="축소"><i class="fa-solid fa-magnifying-glass-minus"></i></button>
            </div>
        </main>

        <!-- Right Side: AI -->
        <aside class="chat-panel shadow-2xl" id="chat-sidebar">
            <div class="p-8 border-b border-gray-800 flex justify-between items-center bg-slate-900/50">
                <div class="flex items-center gap-4">
                    <div class="w-10 h-10 rounded-full bg-blue-900/50 flex items-center justify-center text-blue-500 border border-blue-500/30">
                        <i class="fa-solid fa-brain text-blue-500"></i>
                    </div>
                    <div>
                        <h2 class="text-sm font-black uppercase tracking-widest text-blue-100">KAFVI AI ANALYST</h2>
                        <p class="text-[9px] text-gray-500 font-bold uppercase mt-0.5">Gemini 2.5 Intelligence</p>
                    </div>
                </div>
            </div>
            
            <div class="chat-messages space-y-5" id="chat-box">
                <div class="bg-blue-600/10 p-5 rounded-[1.5rem] border border-blue-500/20 text-blue-100">
                    <p class="text-xs leading-relaxed font-bold">
                        소장님, 반갑습니다. 릴리즈 자산 기반의 실시간 분석 및 마케팅 전략 제언을 위해 상시 대기 중입니다.
                    </p>
                </div>
            </div>

            <div class="chat-input-area">
                <div class="relative flex items-center">
                    <input type="text" id="chat-input" placeholder="분석 명령을 내리십시오..." 
                           class="w-full bg-gray-800/50 border border-gray-700 rounded-[1.5rem] py-4 pl-6 pr-14 text-sm focus:outline-none focus:border-blue-500 transition-all text-white">
                    <button onclick="askAI()" id="send-btn" class="absolute right-3 p-3 text-blue-500 hover:text-blue-400">
                        <i class="fa-solid fa-paper-plane text-xl"></i>
                    </button>
                </div>
                <p id="api-status" class="text-[9px] text-center mt-3 text-red-500 font-bold hidden uppercase tracking-widest italic animate-pulse">Gemini API Key Required</p>
            </div>
        </aside>
    </div>

    <script>
        /**
         * [소장님 전용 설정]
         * 1. apiKey: Gemini 키만 한 번 넣어주세요.
         * 2. 이제 릴리즈에 파일만 올리시면 끝납니다.
         */
        const apiKey = ""; 
        const MODEL = "gemini-2.5-flash-preview-09-2025";

        const container = document.getElementById('series-container');
        const frame = document.getElementById('viewer-frame');
        const loader = document.getElementById('loader');
        const loaderText = document.getElementById('loader-text');
        const welcome = document.getElementById('welcome');
        const zoomText = document.getElementById('zoom-text');
        const chatBox = document.getElementById('chat-box');
        
        let activeIdx = -1;
        let currentScale = 1;
        let reportSeries = [];

        // 깃허브 API를 통해 모든 릴리즈 자산 자동 획득
        async function fetchGitHubAssets() {
            const host = window.location.hostname;
            const path = window.location.pathname;
            
            let owner = host.split('.')[0];
            let repo = path.split('/')[1] || "";

            // 소장님 전용 예외 경로 처리
            if(owner === "jongcheon-kim" || host.includes("github.io")) {
                owner = "jongcheon-kim";
                repo = "fishery-intelligence-webplay";
            }

            if (!owner || !repo) return;

            loader.classList.remove('hidden');
            try {
                const response = await fetch(`https://api.github.com/repos/${owner}/${repo}/releases`);
                const releases = await response.json();
                
                let allAssets = [];
                releases.forEach(rel => {
                    if(rel.assets) {
                        rel.assets.forEach(asset => {
                            if(asset.name.endsWith('.html') && asset.name !== 'index.html') {
                                allAssets.push({
                                    id: asset.name.replace('.html', ''),
                                    title: asset.label || asset.name.replace('.html', ''),
                                    url: asset.browser_download_url, // 깃허브 자산 원본 링크
                                    version: rel.tag_name,
                                    published: new Date(rel.published_at).toLocaleDateString()
                                });
                            }
                        });
                    }
                });

                // 숫자 정렬 (01, 02...)
                reportSeries = allAssets.sort((a, b) => a.id.localeCompare(b.id, undefined, {numeric: true}));
                renderList();
            } catch (err) {
                container.innerHTML = `<p class="text-red-500 text-[10px] text-center italic py-10">GitHub Sync Fail</p>`;
            } finally {
                loader.classList.add('hidden');
            }
        }

        function renderList() {
            if (reportSeries.length === 0) {
                container.innerHTML = `<p class="text-[10px] text-gray-600 italic text-center py-10 uppercase tracking-widest text-white">No Assets Found</p>`;
                return;
            }
            container.innerHTML = reportSeries.map((file, idx) => `
                <div class="report-card p-5 rounded-[1.8rem] flex items-center gap-6" id="card-${idx}" onclick="selectReport(${idx})">
                    <div class="number-tag text-gray-400">${file.id}</div>
                    <div class="overflow-hidden flex-1">
                        <div class="flex items-center">
                           <p class="text-[10px] text-blue-500 font-bold uppercase tracking-widest opacity-60 italic">${file.version}</p>
                           <span class="badge-v text-white">${file.published}</span>
                        </div>
                        <h3 class="text-[14px] font-black text-white truncate tracking-tighter mt-1 text-white">${file.title}</h3>
                    </div>
                </div>
            `).join('');
        }

        /**
         * [소장님 의도 핵심 구현: 다운로드 방지 플레이 모드]
         * 릴리즈 파일을 주소로 연결하면 무조건 다운로드되므로,
         * 앱이 파일을 '직접 읽어서(fetch)' iframe의 내용으로 주입합니다.
         */
        async function selectReport(idx) {
            if (activeIdx === idx) return;
            
            document.querySelectorAll('.report-card').forEach(c => c.classList.remove('active'));
            document.getElementById(`card-${idx}`).classList.add('active');
            activeIdx = idx;
            
            welcome.classList.add('hidden');
            frame.classList.add('hidden');
            loader.classList.remove('hidden');
            loaderText.innerText = "Direct Streaming Data...";
            resetZoom();
            
            try {
                // 파일을 주소로 열지 않고, '텍스트 데이터'로 긁어옵니다 (다운로드 방지 핵심)
                const response = await fetch(reportSeries[idx].url);
                const htmlContent = await response.text();
                
                // 긁어온 텍스트를 iframe의 '소스 문서'로 직접 주입 (플레이 모드)
                frame.srcdoc = htmlContent;
                
                frame.onload = () => {
                    loader.classList.add('hidden');
                    frame.classList.remove('hidden');
                    addAiMessage(`시스템: 릴리즈 ${reportSeries[idx].id}번 '${reportSeries[idx].title}' 스트리밍 플레이 완료.`);
                };
            } catch (err) {
                addAiMessage("오류: 릴리즈 파일을 읽어오는 데 실패했습니다. CORS 설정을 확인하세요.");
                loader.classList.add('hidden');
            }
        }

        function zoomViewer(f) { currentScale *= f; applyScale(); }
        function resetZoom() { currentScale = 1; applyScale(); }
        function applyScale() {
            frame.style.transform = `scale(${currentScale})`;
            zoomText.innerText = `${Math.round(currentScale * 100)}%`;
            frame.style.height = currentScale > 1 ? (100 / currentScale) + "%" : "100%";
            frame.style.width = currentScale > 1 ? (100 / currentScale) + "%" : "100%";
        }

        function toggleChat() { document.getElementById('chat-sidebar').classList.toggle('hidden'); }

        async function askAI() {
            const input = document.getElementById('chat-input');
            const apiStatus = document.getElementById('api-status');
            const userMsg = input.value.trim();
            if (!userMsg) return;
            if (!apiKey) { apiStatus.classList.remove('hidden'); return; }
            apiStatus.classList.add('hidden');

            addUserMessage(userMsg);
            input.value = "";

            let context = activeIdx !== -1 ? `현재 소장님은 '${reportSeries[activeIdx].title}' 문서를 분석 중입니다.` : "현재 열려있는 리포트가 없습니다.";

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${MODEL}:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: `${context}\n\n질문: ${userMsg}` }] }],
                        tools: [{ "google_search": {} }],
                        systemInstruction: { 
                            parts: [{ text: "당신은 한국AI어촌가치연구소의 AI 수석 연구원입니다. 소장 김종천님께 수산물 분석 및 마케팅 전략을 정중하고 데이터 기반의 전문적인 어조로 제언하세요." }] 
                        }
                    })
                });
                const data = await response.json();
                const aiText = data.candidates?.[0]?.content?.parts?.[0]?.text || "데이터 분석 중...";
                addAiMessage(aiText);
            } catch (err) { addAiMessage("연결 오류: API 설정을 확인하십시오."); }
        }

        function addUserMessage(msg) {
            chatBox.innerHTML += `<div class="text-right text-white"><p class="inline-block bg-blue-600 p-4 rounded-[1.5rem] rounded-tr-none text-xs text-white max-w-[90%] font-bold shadow-lg">${msg}</p></div>`;
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        function addAiMessage(msg) {
            chatBox.innerHTML += `<div class="bg-gray-800 p-5 rounded-[1.5rem] rounded-tl-none border border-gray-700 shadow-xl text-gray-300 text-[13px] leading-relaxed">${msg}</div>`;
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        document.getElementById('chat-input').addEventListener('keypress', (e) => { if (e.key === 'Enter') askAI(); });
        window.onload = fetchGitHubAssets;
    </script>
</body>
</html>
